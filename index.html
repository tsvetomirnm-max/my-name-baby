<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Моето Име</title>
  <style>
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; margin:0; background:#FAFBFC; color:#0F172A;}
    .wrap{max-width:720px; margin:60px auto; padding:0 16px;}
    .card{background:#fff; border:1px solid #E5E7EB; border-radius:14px; padding:24px; box-shadow:0 2px 8px rgba(0,0,0,.04); margin-bottom:20px;}
    h1{font-size:28px; margin:0 0 12px;}
    h2{font-size:20px; margin:0 0 10px;}
    p{margin:8px 0 16px; color:#64748B;}
    ul{list-style:none; padding-left:0; margin:0}
    li{padding:10px 0; border-bottom:1px solid #F1F5F9; display:flex; justify-content:space-between; gap:12px}
    .muted{color:#64748B; font-size:14px}
    label{display:block; font-size:14px; color:#334155; margin-top:10px}
    input, select, button{font:inherit}
    input[type="text"], select{
      width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid #E5E7EB; border-radius:10px; outline:none;
    }
    /* primary buttons */
    button{margin-top:12px; padding:10px 16px; border-radius:999px; border:0; background:#1E90FF; color:#fff; cursor:pointer}

    /* chips (browse filters) */
    .chips{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px}
    .chip{
      padding:6px 10px; border:1px solid #E5E7EB; border-radius:999px; cursor:pointer;
      background:#fff; color:#0F172A;
    }
    .chip.active{background:#1E90FF; color:#fff; border-color:#1E90FF}
    .chip:focus-visible{outline:2px solid #1E90FF; outline-offset:2px}

    /* grid helpers */
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}

    .ok{color:#0f766e}
    .err{color:#b91c1c}

    /* Stars */
    .star-wrap{display:flex; gap:10px; align-items:center; padding:4px 0}
    .star{
      width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center;
      cursor:pointer; border:0; background:transparent; padding:0;
    }
    .star svg{width:36px; height:36px; stroke:#1E90FF; stroke-width:2px; fill:transparent; transition:fill .12s ease}
    .star.filled svg{fill:#1E90FF}
    .star:focus-visible{outline:2px solid #1E90FF; border-radius:6px; outline-offset:2px}

    /* Radio pills (gender) */
    .radio-group{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:6px}
    .radio{display:none}
    .radio + label{
      display:inline-block; padding:8px 12px; border:1px solid #E5E7EB; border-radius:999px; cursor:pointer;
      background:#fff; color:#0F172A; user-select:none;
    }
    .radio:checked + label{ background:#1E90FF; color:#fff; border-color:#1E90FF }
    .radio:focus-visible + label{ outline:2px solid #1E90FF; outline-offset:2px }
    .radio[disabled] + label{ opacity:.5; cursor:not-allowed }
    .radio-group.disabled label{ opacity:.5; pointer-events:none }
    .tiny{font-size:12px; color:#64748B; margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- RATING CARD FIRST -->
    <div class="card">
      <h1>Колко обичаш името си</h1>
      <p class="muted">Въведи името си на кирилица, избери възрастова група и постави оценка 1–5.</p>

      <label>Твоето име (на кирилица)
        <input id="myName" type="text" placeholder="напр. Цветомир" />
      </label>

      <!-- Gender as radio pills -->
      <div>
        <span class="muted">Пол (ако добавяме ново име)</span>
        <div id="genderGroup" class="radio-group" role="radiogroup" aria-label="Пол">
          <input class="radio" type="radio" name="gender" id="g-m" value="m"><label for="g-m">Мъжки</label>
          <input class="radio" type="radio" name="gender" id="g-f" value="f"><label for="g-f">Женски</label>
          <input class="radio" type="radio" name="gender" id="g-u" value="u"><label for="g-u">За всички</label>
        </div>
        <div id="genderHint" class="tiny"></div>
      </div>

      <div class="row">
        <label>Възрастова група
          <select id="age">
            <option value="">Без посочване</option>
            <option>10-19</option><option>20-29</option><option>30-39</option>
            <option>40-49</option><option>50-59</option><option>60+</option>
          </select>
        </label>

        <label>Оценка (1–5)
          <div id="star-rating" class="star-wrap" role="radiogroup" aria-label="Оценка 1 до 5">
            <button type="button" class="star" data-value="1" role="radio" aria-checked="false" aria-label="1 звезда">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg>
            </button>
            <button type="button" class="star" data-value="2" role="radio" aria-checked="false" aria-label="2 звезди">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg>
            </button>
            <button type="button" class="star" data-value="3" role="radio" aria-checked="false" aria-label="3 звезди">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg>
            </button>
            <button type="button" class="star" data-value="4" role="radio" aria-checked="false" aria-label="4 звезди">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg>
            </button>
            <button type="button" class="star" data-value="5" role="radio" aria-checked="false" aria-label="5 звезди">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg>
            </button>
          </div>
          <input id="score" type="hidden" value="">
        </label>
      </div>

      <button id="send">Изпрати</button>
      <p id="msg" class="muted"></p>
    </div>

    <!-- BROWSE / SEARCH CARD SECOND -->
    <div class="card">
      <h2>Разгледай имената</h2>
      <label>Търси
        <input id="q" type="text" placeholder="например: Иван, Ро, Ви…" />
      </label>

      <div class="chips" id="chips">
        <button class="chip active" data-g="all">Всички</button>
        <button class="chip" data-g="f">Момичета</button>
        <button class="chip" data-g="m">Момчета</button>
        <button class="chip" data-g="u">За всички</button>
      </div>

      <ul id="search-results"><li class="muted">Топ имена по подразбиране. Използвай търсене или филтри.</li></ul>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // Supabase (public anon key is OK to expose)
    const SUPABASE_URL  = "https://ldabujbsyyqhewzlrjcg.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkYWJ1amJzeXlxaGV3emxyamNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NjE2MjIsImV4cCI6MjA3MzQzNzYyMn0.0s04-DXbURuaadddeWxzQWbpwYEi9_t7NGheMrqEN4w";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);
    const msg  = document.getElementById("msg");

    // tiny debounce helper
    const debounce = (fn, ms=300) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

    function getFingerprint(){
      let id = localStorage.getItem("fp_mnb");
      if(!id){
        id = (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));
        localStorage.setItem("fp_mnb", id);
      }
      return id;
    }

    // slugify + Cyrillic validator
    function slugBg(s){
      s = (s || "").toString().trim().replace(/\u00A0/g, " ");
      const repl = [
        [/щ/gi,"sht"], [/ш/gi,"sh"],  [/ч/gi,"ch"],  [/ж/gi,"zh"],
        [/ц/gi,"ts"],  [/ю/gi,"yu"],  [/я/gi,"ya"],  [/й/gi,"y"],
        [/[\u045D\u040D]/g,"i"],      // ѝ Ѝ
        [/[ьЬ]/g,""],                 // ь
        [/ъ/gi,"a"],
        [/а/gi,"a"], [/б/gi,"b"], [/в/gi,"v"], [/г/gi,"g"], [/д/gi,"d"],
        [/е/gi,"e"], [/з/gi,"z"], [/и/gi,"i"], [/к/gi,"k"], [/л/gi,"l"],
        [/м/gi,"m"], [/н/gi,"n"], [/о/gi,"o"], [/п/gi,"p"], [/р/gi,"r"],
        [/с/gi,"s"], [/т/gi,"t"], [/у/gi,"u"], [/ф/gi,"f"], [/х/gi,"h"]
      ];
      for (const [re,to] of repl) s = s.replace(re,to);
      return s.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
    }
    function makeCyrillicRegex(){
      try { return new RegExp("^\\p{Script=Cyrillic}[\\p{Script=Cyrillic}\\s-]{1,59}$","u"); }
      catch { return /^[\u0400-\u04FF\u0500-\u052F\u2DE0-\u2DFF\uA640-\uA69F][\u0400-\u04FF\u0500-\u052F\u2DE0-\u2DFF\uA640-\uA69F \-]{1,59}$/; }
    }
    const CYRILLIC_NAME_RE = makeCyrillicRegex();
    function isCyrillicName(s){ s=(s||"").trim().replace(/\u00A0/g," "); return CYRILLIC_NAME_RE.test(s); }

    // ===== STAR WIDGET =====
    const stars = Array.from(document.querySelectorAll('#star-rating .star'));
    const scoreInput = document.getElementById('score');
    let chosen = 0;
    function paint(n){ stars.forEach((btn,i)=>{ const filled=i<n; btn.classList.toggle('filled',filled); btn.setAttribute('aria-checked', filled && i+1===n ? 'true':'false'); }); }
    function setScore(n){ chosen=n; scoreInput.value=String(n); paint(n); }
    stars.forEach(btn=>{ const v=Number(btn.dataset.value); btn.addEventListener('mouseenter',()=>paint(v)); btn.addEventListener('mouseleave',()=>paint(chosen)); btn.addEventListener('click',()=>setScore(v)); });
    const group = document.getElementById('star-rating');
    group.addEventListener('keydown',(e)=>{ if(e.key==='ArrowRight'||e.key==='ArrowUp'){e.preventDefault(); setScore(Math.min(5,(chosen||0)+1)); stars[(chosen||1)-1].focus();} if(e.key==='ArrowLeft'||e.key==='ArrowDown'){e.preventDefault(); setScore(Math.max(1,(chosen||1)-1)); stars[(chosen||1)-1].focus();} if(e.key===' '||e.key==='Enter'){e.preventDefault(); setScore(chosen||1);} });
    paint(0);

    // ===== GENDER RADIO + AUTO-DETECT =====
    const nameEl = document.getElementById('myName');
    const gGroup = document.getElementById('genderGroup');
    const gHint  = document.getElementById('genderHint');
    const gM = document.getElementById('g-m'), gF = document.getElementById('g-f'), gU = document.getElementById('g-u');

    function setGenderUI(val, locked=false){
      // clear first
      [gM,gF,gU].forEach(r=>{ r.checked=false; r.disabled=false; });
      gGroup.classList.toggle('disabled', locked);
      gHint.textContent = "";
      if (val==='m') gM.checked = true;
      if (val==='f') gF.checked = true;
      if (val==='u') gU.checked = true;
      if (locked){
        [gM,gF,gU].forEach(r=> r.disabled = true);
        const txt = val==='m' ? 'мъжко' : val==='f' ? 'женско' : 'за всички';
        gHint.textContent = `Разпознато от базата: ${txt} име.`;
      }
    }

    const detectGender = debounce(async ()=>{
      const raw = nameEl.value.trim();
      if (!raw || !isCyrillicName(raw)){ setGenderUI(null,false); return; }
      const slug = slugBg(raw);
      const { data, error } = await supabase.from("names").select("id, gender").eq("normalized_slug", slug).maybeSingle();
      if (error || !data){ setGenderUI(null,false); return; }
      setGenderUI(data.gender, true); // lock radios if found
    }, 300);

    nameEl.addEventListener('input', detectGender);

    // ===== BROWSE / SEARCH =====
    const qInput = document.getElementById("q");
    const chips  = document.getElementById("chips");
    const results = document.getElementById("search-results");
    let currentGender = "all";

    function renderResults(rows){
      results.innerHTML = "";
      if (!rows || rows.length === 0){
        results.innerHTML = '<li class="muted">Няма съвпадения.</li>'; return;
      }
      for (const r of rows){
        const li = document.createElement("li");
        const left = document.createElement("div");
        left.textContent = r.display;
        const right = document.createElement("div");
        right.className = "muted";
        right.textContent = `Носители ★${r.avg_holder ?? "—"} · Общо ★${r.avg_total ?? "—"} · ${r.votes_total ?? 0} гласа`;
        li.append(left,right);
        results.append(li);
      }
    }

    async function searchNow(){
      const term = qInput.value.trim();
      let q = supabase.from("name_stats").select("display, gender, avg_holder, avg_total, votes_total, normalized_slug");
      if (term) q = q.ilike("display", `%${term}%`);
      if (currentGender !== "all") q = q.eq("gender", currentGender);
      q = q.order("bayesian_total", { ascending:false }).limit(25);
      const { data, error } = await q;
      if (error){ results.innerHTML = `<li class="muted">Грешка: ${error.message}</li>`; return; }
      renderResults(data);
    }
    qInput.addEventListener("input", debounce(searchNow, 250));
    chips.addEventListener("click", (e)=>{
      const btn = e.target.closest(".chip"); if (!btn) return;
      [...chips.querySelectorAll(".chip")].forEach(c=>c.classList.remove("active"));
      btn.classList.add("active");
      currentGender = btn.dataset.g;
      searchNow();
    });
    // initial default: top names
    searchNow();

    // ===== SUBMIT RATING =====
    document.getElementById("send").addEventListener("click", async () => {
      msg.className = "muted"; msg.textContent = "Записваме…";

      const nameInput = nameEl.value.trim();
      const age = document.getElementById("age").value;      // may be ""
      const score = Number(document.getElementById("score").value || 0);

      if (!nameInput || !score) {
        msg.className = "err";
        msg.textContent = "Моля попълни име и оценка (звезди).";
        return;
      }
      if (!isCyrillicName(nameInput)) {
        msg.className = "err";
        msg.textContent = "Моля въведи лично име на кирилица (2–60 знака).";
        return;
      }

      const slug = slugBg(nameInput);

      // find or insert name
      let { data: found, error: findErr } = await supabase
        .from("names").select("id, display")
        .eq("normalized_slug", slug).maybeSingle();
      if (findErr){ msg.className="err"; msg.textContent="Грешка при търсене: " + findErr.message; return; }

      if (!found){
        // need gender selection
        const gender = (gM.checked && 'm') || (gF.checked && 'f') || (gU.checked && 'u') || "";
        if (!gender){
          msg.className="err"; msg.textContent="Името липсва. Моля избери пол, за да го добавим.";
          return;
        }
        const { data: insName, error: insErr } = await supabase
          .from("names").insert({ display: nameInput, normalized_slug: slug, gender })
          .select("id, display").maybeSingle();

        if (insErr){
          if (insErr.message?.toLowerCase().includes("duplicate")){
            const ref = await supabase.from("names").select("id, display").eq("normalized_slug", slug).maybeSingle();
            if (ref.error || !ref.data){ msg.className="err"; msg.textContent="Грешка при добавяне."; return; }
            found = ref.data;
          } else { msg.className="err"; msg.textContent="Неуспешно добавяне на име: " + insErr.message; return; }
        } else { found = insName; }
      }

      // insert rating
      const { error: rateErr } = await supabase.from("ratings").insert({
        name_id: found.id,
        rater_is_holder: true,
        age_bucket: age || null,
        score: score,
        user_fingerprint: getFingerprint()
      });
      if (rateErr){ msg.className="err"; msg.textContent="Неуспешно записване: " + rateErr.message; return; }

      msg.className = "ok"; msg.textContent = "Готово! Благодарим 😊";
      // refresh browse list
      searchNow();
    });
  </script>
</body>
</html>
