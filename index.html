<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ú–æ–µ—Ç–æ –ò–º–µ ‚Äî –ù–∞—á–∞–ª–æ</title>
  <link rel="stylesheet" href="/assets/base.css">
</head>
<body>
  <div class="wrap">
    <nav class="nav">
      <div class="brand">–ú–æ–µ—Ç–æ –ò–º–µ</div>
      <div class="links">
        <a href="/">–ù–∞—á–∞–ª–æ</a>
        <a href="/add-name.html">–î–æ–±–∞–≤–∏ –∏–º–µ</a>
        <a href="/game.html">–ò–≥—Ä–∞</a>
        <a href="/about.html">–ó–∞ –Ω–∞—Å</a>
        <a href="/privacy.html">–ü–æ–≤–µ—Ä–∏—Ç–µ–ª–Ω–æ—Å—Ç</a>
      </div>
    </nav>

    <!-- Holder card -->
    <div class="card" id="holder-card">
      <h1>–ö–æ–ª–∫–æ –æ–±–∏—á–∞—à –∏–º–µ—Ç–æ —Å–∏</h1>
      <p class="muted">–í—ä–≤–µ–¥–∏ –∏–º–µ—Ç–æ —Å–∏ –Ω–∞ –∫–∏—Ä–∏–ª–∏—Ü–∞, –∏–∑–±–µ—Ä–∏ –≤—ä–∑—Ä–∞—Å—Ç–æ–≤–∞ –≥—Ä—É–ø–∞ –∏ –ø–æ—Å—Ç–∞–≤–∏ –æ—Ü–µ–Ω–∫–∞ 1‚Äì5.</p>
      <label>–¢–≤–æ–µ—Ç–æ –∏–º–µ (–Ω–∞ –∫–∏—Ä–∏–ª–∏—Ü–∞)
        <input id="myName" type="text" placeholder="–Ω–∞–ø—Ä. –¶–≤–µ—Ç–æ–º–∏—Ä" />
      </label>
      <div>
        <span class="muted">–ü–æ–ª (–∞–∫–æ –¥–æ–±–∞–≤—è–º–µ –Ω–æ–≤–æ –∏–º–µ)</span>
        <div id="genderGroup" class="radio-group" role="radiogroup" aria-label="–ü–æ–ª">
          <input class="radio" type="radio" name="gender" id="g-m" value="m"><label for="g-m">–ú</label>
          <input class="radio" type="radio" name="gender" id="g-f" value="f"><label for="g-f">–ñ</label>
          <input class="radio" type="radio" name="gender" id="g-u" value="u"><label for="g-u">–ó–∞ –≤—Å–∏—á–∫–∏</label>
        </div>
        <div id="genderHint" class="tiny"></div>
      </div>
      <div class="row">
        <label>–í—ä–∑—Ä–∞—Å—Ç–æ–≤–∞ –≥—Ä—É–ø–∞
          <select id="age">
            <option value="">–ë–µ–∑ –ø–æ—Å–æ—á–≤–∞–Ω–µ</option>
            <option>10-19</option><option>20-29</option><option>30-39</option>
            <option>40-49</option><option>50-59</option><option>60+</option>
          </select>
        </label>
        <label>–û—Ü–µ–Ω–∫–∞ (1‚Äì5)
          <div id="star-rating" class="star-wrap" role="radiogroup" aria-label="–û—Ü–µ–Ω–∫–∞ 1 –¥–æ 5">
  <button type="button" class="star" data-value="1" role="radio" aria-checked="false" aria-label="1 –∑–≤–µ–∑–¥–∞">
    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg>
  </button>
  <button type="button" class="star" data-value="2" role="radio" aria-checked="false" aria-label="2 –∑–≤–µ–∑–¥–∏">
    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg>
  </button>
  <button type="button" class="star" data-value="3" role="radio" aria-checked="false" aria-label="3 –∑–≤–µ–∑–¥–∏">
    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg>
  </button>
  <button type="button" class="star" data-value="4" role="radio" aria-checked="false" aria-label="4 –∑–≤–µ–∑–¥–∏">
    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg>
  </button>
  <button type="button" class="star" data-value="5" role="radio" aria-checked="false" aria-label="5 –∑–≤–µ–∑–¥–∏">
    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg>
  </button>
</div>
<input id="score" type="hidden" value="">


    <!-- Browse / Search -->
    <div class="card">
      <h2>–†–∞–∑–≥–ª–µ–¥–∞–π –∏–º–µ–Ω–∞—Ç–∞</h2>
      <label>–¢—ä—Ä—Å–∏
        <input id="q" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω, –†–æ, –í–∏‚Ä¶" />
      </label>
      <div class="chips" id="chips">
        <button class="chip active" data-g="all">–í—Å–∏—á–∫–∏</button>
        <button class="chip" data-g="f">–ú–æ–º–∏—á–µ—Ç–∞</button>
        <button class="chip" data-g="m">–ú–æ–º—á–µ—Ç–∞</button>
        <button class="chip" data-g="u">–ó–∞ –≤—Å–∏—á–∫–∏</button>
      </div>
      <div class="results-head" id="results-head" style="display:none">
        <div>–ò–º–µ</div><div>–ù–æ—Å–∏—Ç–µ–ª–∏</div><div>–û–±—â–æ</div><div>–ì–ª–∞—Å–æ–≤–µ</div><div>–û—Ü–µ–Ω–∏</div>
      </div>
      <ul id="search-results"><li class="muted">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ‚Ä¶</li></ul>
      <div id="sentinel" class="tiny muted" style="text-align:center;padding:12px;display:none">–ó–∞—Ä–µ–∂–¥–∞–º –æ—â–µ‚Ä¶</div>
    </div>
  </div>
<script type="module">
  import {
    supabase, getFingerprint, slugBg, isCyrillicName,
    ICONS, paintRowStars, debounce, ensureCookieBanner
  } from "/assets/app.js";

  ensureCookieBanner();

  // ---- holder stars (unchanged) ----
  const stars = Array.from(document.querySelectorAll('#star-rating .star'));
  const scoreInput = document.getElementById('score');
  let chosen = 0;
  function paint(n){ stars.forEach((btn,i)=>{ const filled=i<n; btn.classList.toggle('filled',filled); btn.setAttribute('aria-checked', filled && i+1===n ? 'true':'false'); }); }
  function setScore(n){ chosen=n; scoreInput.value=String(n); paint(n); }
  stars.forEach(btn=>{ const v=Number(btn.dataset.value); btn.addEventListener('mouseenter',()=>paint(v)); btn.addEventListener('mouseleave',()=>paint(chosen)); btn.addEventListener('click',()=>setScore(v)); });
  paint(0);

  // ---- gender auto-detect (unchanged) ----
  const nameEl = document.getElementById('myName');
  const gGroup = document.getElementById('genderGroup');
  const gHint  = document.getElementById('genderHint');
  const gM = document.getElementById('g-m'), gF = document.getElementById('g-f'), gU = document.getElementById('g-u');
  function setGenderUI(val, locked=false){
    [gM,gF,gU].forEach(r=>{ r.checked=false; r.disabled=false; });
    gGroup.classList.toggle('disabled', locked);
    gHint.textContent = "";
    if (val==='m') gM.checked = true; if (val==='f') gF.checked = true; if (val==='u') gU.checked = true;
    if (locked){
      [gM,gF,gU].forEach(r=> r.disabled = true);
      const txt = val==='m' ? '–º—ä–∂–∫–æ' : val==='f' ? '–∂–µ–Ω—Å–∫–æ' : '–∑–∞ –≤—Å–∏—á–∫–∏';
      gHint.textContent = `–†–∞–∑–ø–æ–∑–Ω–∞—Ç–æ –æ—Ç –±–∞–∑–∞—Ç–∞: ${txt} –∏–º–µ.`;
    }
  }
  nameEl.addEventListener('input', debounce(async ()=>{
    const raw = nameEl.value.trim();
    if (!raw || !isCyrillicName(raw)){ setGenderUI(null,false); return; }
    const { data } = await supabase.from("names").select("gender").eq("normalized_slug", slugBg(raw)).maybeSingle();
    if (!data){ setGenderUI(null,false); return; }
    setGenderUI(data.gender, true);
  },300));

  // ---- hide holder card after one holder vote (unless ?admin=1) ----
  const isAdmin = new URLSearchParams(location.search).has("admin");
  async function enforceSingleHolderCard(){
    if (isAdmin) return;
    const { data } = await supabase.from("ratings")
      .select("id").eq("user_fingerprint", getFingerprint()).eq("rater_is_holder", true).maybeSingle();
    if (data) document.getElementById('holder-card').style.display = 'none';
  }
  enforceSingleHolderCard();

  // ---- submit holder rating (unchanged) ----
  const msg  = document.getElementById("msg");
  document.getElementById("send").addEventListener("click", async () => {
    msg.className = "muted"; msg.textContent = "–ó–∞–ø–∏—Å–≤–∞–º–µ‚Ä¶";
    const nameInput = nameEl.value.trim();
    const age = document.getElementById("age").value;
    const score = Number(scoreInput.value || 0);
    if (!nameInput || !score){ msg.className="err"; msg.textContent="–ú–æ–ª—è –ø–æ–ø—ä–ª–Ω–∏ –∏–º–µ –∏ –æ—Ü–µ–Ω–∫–∞ (–∑–≤–µ–∑–¥–∏)."; return; }
    if (!isCyrillicName(nameInput)){ msg.className="err"; msg.textContent="–ú–æ–ª—è –≤—ä–≤–µ–¥–∏ –ª–∏—á–Ω–æ –∏–º–µ –Ω–∞ –∫–∏—Ä–∏–ª–∏—Ü–∞ (2‚Äì60 –∑–Ω–∞–∫–∞)."; return; }

    const slug = slugBg(nameInput);
    let { data: found, error: findErr } = await supabase.from("names").select("id,display").eq("normalized_slug", slug).maybeSingle();
    if (findErr){ msg.className="err"; msg.textContent="–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ: " + findErr.message; return; }
    if (!found){
      const gender = (gM.checked && 'm') || (gF.checked && 'f') || (gU.checked && 'u') || "";
      if (!gender){ msg.className="err"; msg.textContent="–ò–º–µ—Ç–æ –ª–∏–ø—Å–≤–∞. –ú–æ–ª—è –∏–∑–±–µ—Ä–∏ –ø–æ–ª, –∑–∞ –¥–∞ –≥–æ –¥–æ–±–∞–≤–∏–º."; return; }
      const ins = await supabase.from("names").insert({ display: nameInput, normalized_slug: slug, gender }).select("id,display").maybeSingle();
      if (ins.error){
        if (ins.error.message?.toLowerCase().includes("duplicate")){
          const ref = await supabase.from("names").select("id,display").eq("normalized_slug", slug).maybeSingle();
          if (ref.error || !ref.data){ msg.className="err"; msg.textContent="–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤—è–Ω–µ."; return; }
          found = ref.data;
        } else { msg.className="err"; msg.textContent="–ù–µ—É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤—è–Ω–µ: " + ins.error.message; return; }
      } else { found = ins.data; }
    }

    const up = await supabase.from("ratings").upsert({
      name_id: found.id, rater_is_holder: true, age_bucket: age || null, score,
      user_fingerprint: getFingerprint()
    }, { onConflict: 'name_id,user_fingerprint' });

    if (up.error){
      const txt = (up.error.message||"").toLowerCase().includes("uq_one_holder_per_device")
        ? "–í–µ—á–µ —Å–∏ –¥–æ–±–∞–≤–∏–ª –∏–º–µ –∫–∞—Ç–æ –Ω–æ—Å–∏—Ç–µ–ª –æ—Ç —Ç–æ–≤–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ."
        : ("–ù–µ—É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–≤–∞–Ω–µ: " + up.error.message);
      msg.className="err"; msg.textContent=txt; return;
    }
    msg.className="ok"; msg.textContent="–ì–æ—Ç–æ–≤–æ! –ë–ª–∞–≥–æ–¥–∞—Ä–∏–º üòä";
    enforceSingleHolderCard();
  });

  // ============================
  //   BROWSE with infinite scroll
  // ============================
  const head    = document.getElementById('results-head');
  const results = document.getElementById('search-results');
  const sentinel= document.getElementById('sentinel');
  const chips   = document.getElementById("chips");
  const qInput  = document.getElementById("q");

  let currentGender = "all";
  let pageSize = 25, offset = 0, loading = false, hasMore = true;
  let myVotes = new Map();

  function showError(text){
    results.innerHTML = `<li class="muted">–ì—Ä–µ—à–∫–∞: ${text}</li>`;
    head.style.display = "none";
    sentinel.style.display = "none";
  }

  function rowHTML(r){
    const nameLink = `/name.html?s=${encodeURIComponent(r.normalized_slug || '')}`;
    return `
      <li class="result-row" data-id="${r.id}">
        <div><a href="${nameLink}">${r.display}</a></div>
        <div class="muted">${(r.avg_holder ?? "‚Äî")} ${ICONS.star14}</div>
        <div class="muted">${(r.avg_total  ?? "‚Äî")} ${ICONS.star14}</div>
        <div class="muted">${(r.votes_total ?? 0)} ${ICONS.person14}</div>
        <div>
          <div class="rate-line">
            <span class="cta-mini">–û—Ü–µ–Ω–∏</span>
            <div class="row-stars" role="radiogroup" aria-label="–û—Ü–µ–Ω–∫–∞ (–ø–æ—Å–µ—Ç–∏—Ç–µ–ª)">
              <button type="button" class="row-star" data-v="1"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg></button>
              <button type="button" class="row-star" data-v="2"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg></button>
              <button type="button" class="row-star" data-v="3"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg></button>
              <button type="button" class="row-star" data-v="4"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg></button>
              <button type="button" class="row-star" data-v="5"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg></button>
            </div>
            <span class="saved-tick" title="–ó–∞–ø–∏—Å–∞–Ω–æ">‚úî</span>
          </div>
        </div>
      </li>`;
  }

  async function tryQuery(pageOffset, size){
    // First try the stats view
    const term = qInput.value.trim();
    let q = supabase.from("name_stats")
      .select("id, display, gender, avg_holder, avg_total, votes_total, normalized_slug")
      .order("bayesian_total", { ascending:false })
      .range(pageOffset, pageOffset + size - 1);

    if (term) q = q.ilike("display", `%${term}%`);
    if (currentGender !== "all") q = q.eq("gender", currentGender);

    const res = await q;
    // If relation/view missing, fallback to names
    if (res.error && /relation .*name_stats.* does not exist/i.test(res.error.message)){
      let q2 = supabase.from("names")
        .select("id, display, gender, normalized_slug")
        .order("display", { ascending:true })
        .range(pageOffset, pageOffset + size - 1);
      if (term) q2 = q2.ilike("display", `%${term}%`);
      if (currentGender !== "all") q2 = q2.eq("gender", currentGender);
      const res2 = await q2;
      if (res2.error) return { data:null, error:res2.error };
      // map to expected shape (no stats yet)
      const mapped = (res2.data||[]).map(r => ({...r, avg_holder:null, avg_total:null, votes_total:0}));
      return { data: mapped, error: null, fallback:true };
    }
    return res;
  }

  async function loadPage({ reset=false }={}){
    if (loading || !hasMore) return;
    loading = true;
    sentinel.style.display = "block";
    if (reset){ results.innerHTML=""; offset=0; hasMore=true; myVotes = new Map(); }

    const { data, error } = await tryQuery(offset, pageSize);
    if (error){ showError(error.message); loading=false; return; }

    head.style.display = (offset===0 && data.length===0) ? "none" : "grid";

    // My votes for these ids (if any)
    const ids = (data||[]).map(r=>r.id);
    if (ids.length){
      const mine = await supabase.from("ratings").select("name_id, score")
        .in("name_id", ids).eq("user_fingerprint", getFingerprint());
      (mine.data||[]).forEach(v=> myVotes.set(v.name_id, v.score));
    }

    // Append
    results.insertAdjacentHTML("beforeend", (data||[]).map(rowHTML).join(""));
    (data||[]).forEach(r=>{
      const row = results.querySelector(`.result-row[data-id="${r.id}"]`);
      const bar = row?.querySelector(".row-stars");
      if (bar) paintRowStars(bar, myVotes.get(r.id)||0);
    });

    offset += data.length;
    hasMore = data.length === pageSize;
    sentinel.style.display = hasMore ? "block" : "none";
    loading = false;
  }

  // Infinite scroll observer
  const io = new IntersectionObserver((entries)=>{
    if (entries.some(e=>e.isIntersecting)) loadPage();
  }, { rootMargin: "200px" });
  io.observe(sentinel);

  // Search & filter reset
  const doReset = debounce(()=>loadPage({reset:true}), 300);
  qInput.addEventListener("input", doReset);
  document.getElementById("chips").addEventListener("click", (e)=>{
    const btn = e.target.closest(".chip"); if (!btn) return;
    [...document.querySelectorAll("#chips .chip")].forEach(c=>c.classList.remove("active"));
    btn.classList.add("active"); currentGender = btn.dataset.g; doReset();
  });

  // Initial page load
  loadPage({reset:true}).catch(err => showError(err.message || String(err)));

  // Quick rating save (no reordering)
  const pendingTimers = new Map(), pendingValues = new Map();
  results.addEventListener("click", async (e)=>{
    const star = e.target.closest(".row-star"); if (!star) return;
    const row = star.closest(".result-row"); const nameId = row?.dataset?.id; if (!nameId) return;
    const val = Number(star.dataset.v || 0);
    const bar = row.querySelector(".row-stars");
    paintRowStars(bar, val);

    pendingValues.set(nameId, val);
    const old = pendingTimers.get(nameId); if (old) clearTimeout(old);
    const tid = setTimeout(async ()=>{
      const score = pendingValues.get(nameId);
      pendingTimers.delete(nameId); pendingValues.delete(nameId);
      const { error } = await supabase.from("ratings").upsert({
        name_id: nameId, rater_is_holder: false, age_bucket: null, score, user_fingerprint: getFingerprint()
      }, { onConflict: 'name_id,user_fingerprint' });

      if (!error){
        const tick = row.querySelector(".saved-tick");
        if (tick){ tick.classList.add("show"); setTimeout(()=>tick.classList.remove("show"),1600); }
      } else {
        const m = document.createElement('div'); m.className="muted tiny"; m.textContent="–ù–µ—É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–≤–∞–Ω–µ: "+(error.message||"–≥—Ä–µ—à–∫–∞"); row.append(m);
      }
    }, 1800);
    pendingTimers.set(nameId, tid);
  });
</script>


</body>
</html>
