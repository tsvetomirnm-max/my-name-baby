<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Моето Име</title>
  <style>
  body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; margin:0; background:#FAFBFC; color:#0F172A;}
  .wrap{max-width:720px; margin:60px auto; padding:0 16px;}
  .card{background:#fff; border:1px solid #E5E7EB; border-radius:14px; padding:24px; box-shadow:0 2px 8px rgba(0,0,0,.04); margin-bottom:20px;}
  h1{font-size:28px; margin:0 0 12px;}
  h2{font-size:20px; margin:0 0 10px;}
  p{margin:8px 0 16px; color:#64748B;}
  ul{list-style:none; padding-left:0; margin:0}
  li{padding:10px 0; border-bottom:1px solid #F1F5F9; display:flex; justify-content:space-between; gap:12px}
  .muted{color:#64748B; font-size:14px}
  label{display:block; font-size:14px; color:#334155; margin-top:10px}
  input, select, button{font:inherit}
  input[type="text"], select{
    width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid #E5E7EB; border-radius:10px; outline:none;
  }

  /* primary buttons */
  button{margin-top:12px; padding:10px 16px; border-radius:999px; border:0; background:#1E90FF; color:#fff; cursor:pointer}

  /* chips (override button styles) */
  .chips{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px}
  .chip{
    padding:6px 10px;
    border:1px solid #E5E7EB;
    border-radius:999px;
    cursor:pointer;
    background:#fff;
    color:#0F172A;          /* visible text when inactive */
  }
  .chip.active{
    background:#1E90FF;
    color:#fff;             /* white text when active */
    border-color:#1E90FF;
  }
  .chip:focus-visible{outline:2px solid #1E90FF; outline-offset:2px}

  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
  .ok{color:#0f766e}
  .err{color:#b91c1c}
</style>
</head>
<body>
  <div class="wrap">

    <!-- READ LIST -->
    <div class="card">
      <h1>Моето Име</h1>
      <p class="muted">Тестово извличаме топ 10 имена директно от базата.</p>
      <ul id="top-names"><li class="muted">Зареждане…</li></ul>
    </div>

 <div class="card">
  <h2>Разгледай имената</h2>
  <label>Търси
    <input id="q" type="text" placeholder="например: Иван, Ро, Ви…" />
  </label>

  <div class="chips" id="chips">
    <button class="chip active" data-g="all">Всички</button>
    <button class="chip" data-g="f">Момичета</button>
    <button class="chip" data-g="m">Момчета</button>
    <button class="chip" data-g="u">За Всички</button>
  </div>

  <ul id="search-results"><li class="muted">Започни да пишеш или избери филтър.</li></ul>
</div>
  
    <!-- WRITE ONE RATING (can add name if missing) -->
    <div class="card">
      <h2>Дай оценка за собственото си име</h2>
      <p class="muted">Ако името липсва, ще го добавим със зададения пол.</p>

      <label>Твоето име (на кирилица)
        <input id="myName" type="text" placeholder="напр. Цветомир" />
      </label>

      <div class="row3">
        <label>Пол (ако добавяме ново име)
          <select id="gender">
            <option value="">— избери —</option>
            <option value="m">М</option>
            <option value="f">Ж</option>
            <option value="u">Уни</option>
          </select>
        </label>

        <label>Възрастова група
          <select id="age">
            <option value="">— избери —</option>
            <option>0-9</option><option>10-19</option><option>20-29</option>
            <option>30-39</option><option>40-49</option><option>50-59</option><option>60+</option>
          </select>
        </label>

        <label>Оценка (1–5)
          <select id="score">
            <option value="">— избери —</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          </select>
        </label>
      </div>

      <button id="send">Изпрати</button>
      <p id="msg" class="muted"></p>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // Supabase (public anon key is OK to expose)
    const SUPABASE_URL  = "https://ldabujbsyyqhewzlrjcg.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkYWJ1amJzeXlxaGV3emxyamNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NjE2MjIsImV4cCI6MjA3MzQzNzYyMn0.0s04-DXbURuaadddeWxzQWbpwYEi9_t7NGheMrqEN4w";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);
    const list = document.getElementById("top-names");
    const msg  = document.getElementById("msg");

    function getFingerprint(){
      let id = localStorage.getItem("fp_mnb");
      if(!id){
        id = (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));
        localStorage.setItem("fp_mnb", id);
      }
      return id;
    }

    // Bulgarian slugify (same mapping as our Excel/VBA)
    function slugBg(s){
      s = (s || "").toString().trim().replace(/\u00A0/g, " ");
      const repl = [
        [/щ/gi,"sht"], [/ш/gi,"sh"],  [/ч/gi,"ch"],  [/ж/gi,"zh"],
        [/ц/gi,"ts"],  [/ю/gi,"yu"],  [/я/gi,"ya"],  [/й/gi,"y"],
        [/[\u045D\u040D]/g,"i"],      // ѝ Ѝ
        [/[ьЬ]/g,""],                 // ь
        [/ъ/gi,"a"],
        [/а/gi,"a"], [/б/gi,"b"], [/в/gi,"v"], [/г/gi,"g"], [/д/gi,"d"],
        [/е/gi,"e"], [/з/gi,"z"], [/и/gi,"i"], [/к/gi,"k"], [/л/gi,"l"],
        [/м/gi,"m"], [/н/gi,"n"], [/о/gi,"o"], [/п/gi,"p"], [/р/gi,"r"],
        [/с/gi,"s"], [/т/gi,"t"], [/у/gi,"u"], [/ф/gi,"f"], [/х/gi,"h"]
      ];
      for (const [re,to] of repl) s = s.replace(re,to);
      return s.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
    }
// fast Cyrillic validator (2–60 chars, letters + space/hyphen)
// Uses Unicode property escapes when available, else a fallback range.
function makeCyrillicRegex(){
  try { return new RegExp("^\\p{Script=Cyrillic}[\\p{Script=Cyrillic}\\s-]{1,59}$","u"); }
  catch { return /^[\u0400-\u04FF\u0500-\u052F\u2DE0-\u2DFF\uA640-\uA69F][\u0400-\u04FF\u0500-\u052F\u2DE0-\u2DFF\uA640-\uA69F \-]{1,59}$/; }
}
const CYRILLIC_NAME_RE = makeCyrillicRegex();

function isCyrillicName(s){
  s = (s||"").trim().replace(/\u00A0/g," ");
  return CYRILLIC_NAME_RE.test(s);
}
    // READ: top 10
    async function loadTop(){
      const { data, error } = await supabase
        .from("name_stats")
        .select("*")
        .order("bayesian_holder", { ascending:false })
        .limit(10);

      list.innerHTML = "";
      if (error) { list.innerHTML = `<li class="muted">Грешка: ${error.message}</li>`; return; }
      if (!data || data.length === 0) { list.innerHTML = '<li class="muted">Няма данни още.</li>'; return; }
      for (const row of data) {
        const li = document.createElement("li");
        const left = document.createElement("div");
        left.textContent = row.display;
        const right = document.createElement("div");
        right.className = "muted";
        right.textContent = `Носители ★${row.avg_holder ?? "—"} · Общо ★${row.avg_total ?? "—"}`;
        li.append(left,right);
        list.append(li);
      }
    }
    await loadTop();

    // tiny debounce helper
const debounce = (fn, ms=300) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

const qInput = document.getElementById("q");
const chips  = document.getElementById("chips");
const results = document.getElementById("search-results");

let currentGender = "all";

function renderResults(rows){
  results.innerHTML = "";
  if (!rows || rows.length === 0){
    results.innerHTML = '<li class="muted">Няма съвпадения.</li>';
    return;
  }
  for (const r of rows){
    const li = document.createElement("li");
    const left = document.createElement("div");
    left.textContent = r.display;
    const right = document.createElement("div");
    right.className = "muted";
    right.textContent = `Носители ★${r.avg_holder ?? "—"} · Общо ★${r.avg_total ?? "—"} · ${r.votes_total ?? 0} гласа`;
    li.append(left,right);
    results.append(li);
  }
}

async function searchNow(){
  const term = qInput.value.trim();
  let q = supabase.from("name_stats").select("display, gender, avg_holder, avg_total, votes_total, normalized_slug");

  if (term) q = q.ilike("display", `%${term}%`);
  if (currentGender !== "all") q = q.eq("gender", currentGender);

  // show something sensible even with empty search
  q = q.order("bayesian_total", { ascending:false }).limit(25);

  const { data, error } = await q;
  if (error){
    results.innerHTML = `<li class="muted">Грешка: ${error.message}</li>`;
    return;
  }
  renderResults(data);
}

// events
qInput.addEventListener("input", debounce(searchNow, 250));

chips.addEventListener("click", (e)=>{
  const btn = e.target.closest(".chip");
  if (!btn) return;
  [...chips.querySelectorAll(".chip")].forEach(c=>c.classList.remove("active"));
  btn.classList.add("active");
  currentGender = btn.dataset.g;
  searchNow();
});

// initial load for "Всички"
searchNow();


    // WRITE: add name if missing, then insert rating
    document.getElementById("send").addEventListener("click", async () => {
      msg.className = "muted";
      msg.textContent = "Записваме…";

      const nameInput = document.getElementById("myName").value.trim();
      const age = document.getElementById("age").value;
      const score = Number(document.getElementById("score").value || 0);
      const gender = document.getElementById("gender").value; // may be empty

      if (!nameInput || !age || !score) {
        msg.className = "err"; msg.textContent = "Моля попълни име, възраст и оценка."; return;
      }

      if (!isCyrillicName(nameInput)) {
  msg.className = "err";
  msg.textContent = "Моля въведи лично име на кирилица (2–60 знака).";
  return;
}
      const slug = slugBg(nameInput);

      // 1) Try to find the name by slug
      let { data: found, error: findErr } = await supabase
        .from("names")
        .select("id, display")
        .eq("normalized_slug", slug)
        .maybeSingle();

      if (findErr) { msg.className = "err"; msg.textContent = "Грешка при търсене: " + findErr.message; return; }

      // 2) If missing, create it (requires gender)
      if (!found) {
        if (!gender) { msg.className = "err"; msg.textContent = "Името липсва. Моля избери пол, за да го добавим."; return; }

        const { data: insName, error: insNameErr } = await supabase
          .from("names")
          .insert({ display: nameInput, normalized_slug: slug, gender })
          .select("id, display")
          .maybeSingle();

        if (insNameErr) {
          // if conflict on slug (race condition), refetch and continue
          if (insNameErr.message && insNameErr.message.toLowerCase().includes("duplicate")) {
            const refetch = await supabase.from("names").select("id, display").eq("normalized_slug", slug).maybeSingle();
            if (refetch.error || !refetch.data) { msg.className="err"; msg.textContent="Грешка при добавяне."; return; }
            found = refetch.data;
          } else {
            msg.className = "err"; msg.textContent = "Неуспешно добавяне на име: " + insNameErr.message; return;
          }
        } else {
          found = insName;
        }
      }

      // 3) Insert rating (as holder)
      const { error: insRateErr } = await supabase.from("ratings").insert({
        name_id: found.id,
        rater_is_holder: true,
        age_bucket: age,
        score: score,
        user_fingerprint: getFingerprint()
      });

      if (insRateErr) { msg.className = "err"; msg.textContent = "Неуспешно записване: " + insRateErr.message; return; }

      msg.className = "ok";
      msg.textContent = "Готово! Благодарим 😊";
      await loadTop();
    });
  </script>
</body>
</html>
