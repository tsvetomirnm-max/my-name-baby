<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ú–æ–µ—Ç–æ –ò–º–µ</title>
  <style>
  body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; margin:0; background:#FAFBFC; color:#0F172A;}
  .wrap{max-width:720px; margin:60px auto; padding:0 16px;}
  .card{background:#fff; border:1px solid #E5E7EB; border-radius:14px; padding:24px; box-shadow:0 2px 8px rgba(0,0,0,.04); margin-bottom:20px;}
  h1{font-size:28px; margin:0 0 12px;}
  h2{font-size:20px; margin:0 0 10px;}
  p{margin:8px 0 16px; color:#64748B;}
  ul{list-style:none; padding-left:0; margin:0}
  li{padding:10px 0; border-bottom:1px solid #F1F5F9; display:flex; justify-content:space-between; gap:12px}
  .muted{color:#64748B; font-size:14px}
  label{display:block; font-size:14px; color:#334155; margin-top:10px}
  input, select, button{font:inherit}
  input[type="text"], select{
    width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid #E5E7EB; border-radius:10px; outline:none;
  }

  /* primary buttons */
  button{margin-top:12px; padding:10px 16px; border-radius:999px; border:0; background:#1E90FF; color:#fff; cursor:pointer}

  /* chips (override button styles) */
  .chips{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px}
  .chip{
    padding:6px 10px;
    border:1px solid #E5E7EB;
    border-radius:999px;
    cursor:pointer;
    background:#fff;
    color:#0F172A;          /* visible text when inactive */
  }
  .chip.active{
    background:#1E90FF;
    color:#fff;             /* white text when active */
    border-color:#1E90FF;
  }
  .chip:focus-visible{outline:2px solid #1E90FF; outline-offset:2px}

  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
  .ok{color:#0f766e}
  .err{color:#b91c1c}
</style>
</head>
<body>
  <div class="wrap">

    <!-- READ LIST -->
    <div class="card">
      <h1>–ú–æ–µ—Ç–æ –ò–º–µ</h1>
      <p class="muted">–¢–µ—Å—Ç–æ–≤–æ –∏–∑–≤–ª–∏—á–∞–º–µ —Ç–æ–ø 10 –∏–º–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–Ω–æ –æ—Ç –±–∞–∑–∞—Ç–∞.</p>
      <ul id="top-names"><li class="muted">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ‚Ä¶</li></ul>
    </div>

 <div class="card">
  <h2>–†–∞–∑–≥–ª–µ–¥–∞–π –∏–º–µ–Ω–∞—Ç–∞</h2>
  <label>–¢—ä—Ä—Å–∏
    <input id="q" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω, –†–æ, –í–∏‚Ä¶" />
  </label>

  <div class="chips" id="chips">
    <button class="chip active" data-g="all">–í—Å–∏—á–∫–∏</button>
    <button class="chip" data-g="f">–ú–æ–º–∏—á–µ—Ç–∞</button>
    <button class="chip" data-g="m">–ú–æ–º—á–µ—Ç–∞</button>
    <button class="chip" data-g="u">–ó–∞ –í—Å–∏—á–∫–∏</button>
  </div>

  <ul id="search-results"><li class="muted">–ó–∞–ø–æ—á–Ω–∏ –¥–∞ –ø–∏—à–µ—à –∏–ª–∏ –∏–∑–±–µ—Ä–∏ —Ñ–∏–ª—Ç—ä—Ä.</li></ul>
</div>
  
    <!-- WRITE ONE RATING (can add name if missing) -->
    <div class="card">
      <h2>–î–∞–π –æ—Ü–µ–Ω–∫–∞ –∑–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–æ—Ç–æ —Å–∏ –∏–º–µ</h2>
      <p class="muted">–ê–∫–æ –∏–º–µ—Ç–æ –ª–∏–ø—Å–≤–∞, —â–µ –≥–æ –¥–æ–±–∞–≤–∏–º —Å—ä—Å –∑–∞–¥–∞–¥–µ–Ω–∏—è –ø–æ–ª.</p>

      <label>–¢–≤–æ–µ—Ç–æ –∏–º–µ (–Ω–∞ –∫–∏—Ä–∏–ª–∏—Ü–∞)
        <input id="myName" type="text" placeholder="–Ω–∞–ø—Ä. –¶–≤–µ—Ç–æ–º–∏—Ä" />
      </label>

      <div class="row3">
        <label>–ü–æ–ª (–∞–∫–æ –¥–æ–±–∞–≤—è–º–µ –Ω–æ–≤–æ –∏–º–µ)
          <select id="gender">
            <option value="">‚Äî –∏–∑–±–µ—Ä–∏ ‚Äî</option>
            <option value="m">–ú</option>
            <option value="f">–ñ</option>
            <option value="u">–£–Ω–∏</option>
          </select>
        </label>

        <label>–í—ä–∑—Ä–∞—Å—Ç–æ–≤–∞ –≥—Ä—É–ø–∞
          <select id="age">
            <option value="">‚Äî –∏–∑–±–µ—Ä–∏ ‚Äî</option>
            <option>0-9</option><option>10-19</option><option>20-29</option>
            <option>30-39</option><option>40-49</option><option>50-59</option><option>60+</option>
          </select>
        </label>

        <label>–û—Ü–µ–Ω–∫–∞ (1‚Äì5)
          <select id="score">
            <option value="">‚Äî –∏–∑–±–µ—Ä–∏ ‚Äî</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          </select>
        </label>
      </div>

      <button id="send">–ò–∑–ø—Ä–∞—Ç–∏</button>
      <p id="msg" class="muted"></p>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // Supabase (public anon key is OK to expose)
    const SUPABASE_URL  = "https://ldabujbsyyqhewzlrjcg.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkYWJ1amJzeXlxaGV3emxyamNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NjE2MjIsImV4cCI6MjA3MzQzNzYyMn0.0s04-DXbURuaadddeWxzQWbpwYEi9_t7NGheMrqEN4w";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);
    const list = document.getElementById("top-names");
    const msg  = document.getElementById("msg");

    function getFingerprint(){
      let id = localStorage.getItem("fp_mnb");
      if(!id){
        id = (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));
        localStorage.setItem("fp_mnb", id);
      }
      return id;
    }

    // Bulgarian slugify (same mapping as our Excel/VBA)
    function slugBg(s){
      s = (s || "").toString().trim().replace(/\u00A0/g, " ");
      const repl = [
        [/—â/gi,"sht"], [/—à/gi,"sh"],  [/—á/gi,"ch"],  [/–∂/gi,"zh"],
        [/—Ü/gi,"ts"],  [/—é/gi,"yu"],  [/—è/gi,"ya"],  [/–π/gi,"y"],
        [/[\u045D\u040D]/g,"i"],      // —ù –ç
        [/[—å–¨]/g,""],                 // —å
        [/—ä/gi,"a"],
        [/–∞/gi,"a"], [/–±/gi,"b"], [/–≤/gi,"v"], [/–≥/gi,"g"], [/–¥/gi,"d"],
        [/–µ/gi,"e"], [/–∑/gi,"z"], [/–∏/gi,"i"], [/–∫/gi,"k"], [/–ª/gi,"l"],
        [/–º/gi,"m"], [/–Ω/gi,"n"], [/–æ/gi,"o"], [/–ø/gi,"p"], [/—Ä/gi,"r"],
        [/—Å/gi,"s"], [/—Ç/gi,"t"], [/—É/gi,"u"], [/—Ñ/gi,"f"], [/—Ö/gi,"h"]
      ];
      for (const [re,to] of repl) s = s.replace(re,to);
      return s.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
    }
// fast Cyrillic validator (2‚Äì60 chars, letters + space/hyphen)
// Uses Unicode property escapes when available, else a fallback range.
function makeCyrillicRegex(){
  try { return new RegExp("^\\p{Script=Cyrillic}[\\p{Script=Cyrillic}\\s-]{1,59}$","u"); }
  catch { return /^[\u0400-\u04FF\u0500-\u052F\u2DE0-\u2DFF\uA640-\uA69F][\u0400-\u04FF\u0500-\u052F\u2DE0-\u2DFF\uA640-\uA69F \-]{1,59}$/; }
}
const CYRILLIC_NAME_RE = makeCyrillicRegex();

function isCyrillicName(s){
  s = (s||"").trim().replace(/\u00A0/g," ");
  return CYRILLIC_NAME_RE.test(s);
}
    // READ: top 10
    async function loadTop(){
      const { data, error } = await supabase
        .from("name_stats")
        .select("*")
        .order("bayesian_holder", { ascending:false })
        .limit(10);

      list.innerHTML = "";
      if (error) { list.innerHTML = `<li class="muted">–ì—Ä–µ—à–∫–∞: ${error.message}</li>`; return; }
      if (!data || data.length === 0) { list.innerHTML = '<li class="muted">–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –æ—â–µ.</li>'; return; }
      for (const row of data) {
        const li = document.createElement("li");
        const left = document.createElement("div");
        left.textContent = row.display;
        const right = document.createElement("div");
        right.className = "muted";
        right.textContent = `–ù–æ—Å–∏—Ç–µ–ª–∏ ‚òÖ${row.avg_holder ?? "‚Äî"} ¬∑ –û–±—â–æ ‚òÖ${row.avg_total ?? "‚Äî"}`;
        li.append(left,right);
        list.append(li);
      }
    }
    await loadTop();

    // tiny debounce helper
const debounce = (fn, ms=300) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

const qInput = document.getElementById("q");
const chips  = document.getElementById("chips");
const results = document.getElementById("search-results");

let currentGender = "all";

function renderResults(rows){
  results.innerHTML = "";
  if (!rows || rows.length === 0){
    results.innerHTML = '<li class="muted">–ù—è–º–∞ —Å—ä–≤–ø–∞–¥–µ–Ω–∏—è.</li>';
    return;
  }
  for (const r of rows){
    const li = document.createElement("li");
    const left = document.createElement("div");
    left.textContent = r.display;
    const right = document.createElement("div");
    right.className = "muted";
    right.textContent = `–ù–æ—Å–∏—Ç–µ–ª–∏ ‚òÖ${r.avg_holder ?? "‚Äî"} ¬∑ –û–±—â–æ ‚òÖ${r.avg_total ?? "‚Äî"} ¬∑ ${r.votes_total ?? 0} –≥–ª–∞—Å–∞`;
    li.append(left,right);
    results.append(li);
  }
}

async function searchNow(){
  const term = qInput.value.trim();
  let q = supabase.from("name_stats").select("display, gender, avg_holder, avg_total, votes_total, normalized_slug");

  if (term) q = q.ilike("display", `%${term}%`);
  if (currentGender !== "all") q = q.eq("gender", currentGender);

  // show something sensible even with empty search
  q = q.order("bayesian_total", { ascending:false }).limit(25);

  const { data, error } = await q;
  if (error){
    results.innerHTML = `<li class="muted">–ì—Ä–µ—à–∫–∞: ${error.message}</li>`;
    return;
  }
  renderResults(data);
}

// events
qInput.addEventListener("input", debounce(searchNow, 250));

chips.addEventListener("click", (e)=>{
  const btn = e.target.closest(".chip");
  if (!btn) return;
  [...chips.querySelectorAll(".chip")].forEach(c=>c.classList.remove("active"));
  btn.classList.add("active");
  currentGender = btn.dataset.g;
  searchNow();
});

// initial load for "–í—Å–∏—á–∫–∏"
searchNow();


    // WRITE: add name if missing, then insert rating
    document.getElementById("send").addEventListener("click", async () => {
      msg.className = "muted";
      msg.textContent = "–ó–∞–ø–∏—Å–≤–∞–º–µ‚Ä¶";

      const nameInput = document.getElementById("myName").value.trim();
      const age = document.getElementById("age").value;
      const score = Number(document.getElementById("score").value || 0);
      const gender = document.getElementById("gender").value; // may be empty

      if (!nameInput || !age || !score) {
        msg.className = "err"; msg.textContent = "–ú–æ–ª—è –ø–æ–ø—ä–ª–Ω–∏ –∏–º–µ, –≤—ä–∑—Ä–∞—Å—Ç –∏ –æ—Ü–µ–Ω–∫–∞."; return;
      }

      if (!isCyrillicName(nameInput)) {
  msg.className = "err";
  msg.textContent = "–ú–æ–ª—è –≤—ä–≤–µ–¥–∏ –ª–∏—á–Ω–æ –∏–º–µ –Ω–∞ –∫–∏—Ä–∏–ª–∏—Ü–∞ (2‚Äì60 –∑–Ω–∞–∫–∞).";
  return;
}
      const slug = slugBg(nameInput);

      // 1) Try to find the name by slug
      let { data: found, error: findErr } = await supabase
        .from("names")
        .select("id, display")
        .eq("normalized_slug", slug)
        .maybeSingle();

      if (findErr) { msg.className = "err"; msg.textContent = "–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ: " + findErr.message; return; }

      // 2) If missing, create it (requires gender)
      if (!found) {
        if (!gender) { msg.className = "err"; msg.textContent = "–ò–º–µ—Ç–æ –ª–∏–ø—Å–≤–∞. –ú–æ–ª—è –∏–∑–±–µ—Ä–∏ –ø–æ–ª, –∑–∞ –¥–∞ –≥–æ –¥–æ–±–∞–≤–∏–º."; return; }

        const { data: insName, error: insNameErr } = await supabase
          .from("names")
          .insert({ display: nameInput, normalized_slug: slug, gender })
          .select("id, display")
          .maybeSingle();

        if (insNameErr) {
          // if conflict on slug (race condition), refetch and continue
          if (insNameErr.message && insNameErr.message.toLowerCase().includes("duplicate")) {
            const refetch = await supabase.from("names").select("id, display").eq("normalized_slug", slug).maybeSingle();
            if (refetch.error || !refetch.data) { msg.className="err"; msg.textContent="–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤—è–Ω–µ."; return; }
            found = refetch.data;
          } else {
            msg.className = "err"; msg.textContent = "–ù–µ—É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ –∏–º–µ: " + insNameErr.message; return;
          }
        } else {
          found = insName;
        }
      }

      // 3) Insert rating (as holder)
      const { error: insRateErr } = await supabase.from("ratings").insert({
        name_id: found.id,
        rater_is_holder: true,
        age_bucket: age,
        score: score,
        user_fingerprint: getFingerprint()
      });

      if (insRateErr) { msg.className = "err"; msg.textContent = "–ù–µ—É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–≤–∞–Ω–µ: " + insRateErr.message; return; }

      msg.className = "ok";
      msg.textContent = "–ì–æ—Ç–æ–≤–æ! –ë–ª–∞–≥–æ–¥–∞—Ä–∏–º üòä";
      await loadTop();
    });
  </script>
</body>
</html>
