<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Моето Име — Добави име</title>
  <link rel="stylesheet" href="/assets/base.css">
</head>
<body>
  <div class="wrap">
    <nav class="nav">
      <div class="brand"><a href="/">Моето Име</a></div>
      <div class="links">
        <a href="/">Начало</a>
        <a href="/add-name.html">Добави име</a>
        <a href="/game.html">Игра</a>
        <a href="/about.html">За нас</a>
        <a href="/privacy.html">Поверителност</a>
      </div>
    </nav>

    <div class="card">
      <h1>Добави ново име</h1>
      <p class="muted">Ако името вече съществува, записваме само оценката ти.</p>

      <label>Име (кирилица)
        <input id="nm" type="text" placeholder="напр. Теодора">
      </label>

      <div class="radio-group" role="radiogroup" aria-label="Пол">
        <input class="radio" type="radio" name="gender" id="a-m" value="m"><label for="a-m">Мъжки</label>
        <input class="radio" type="radio" name="gender" id="a-f" value="f"><label for="a-f">Женски</label>
        <input class="radio" type="radio" name="gender" id="a-u" value="u"><label for="a-u">За всички</label>
      </div>

      <label style="margin-top:14px">Оценка (1–5)
        <div id="stars" class="star-wrap" role="radiogroup" aria-label="Оценка 1 до 5">
          <button type="button" class="star" data-value="1" aria-label="1 звезда"><svg viewBox="0 0 24 24"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg></button>
          <button type="button" class="star" data-value="2" aria-label="2 звезди"><svg viewBox="0 0 24 24"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg></button>
          <button type="button" class="star" data-value="3" aria-label="3 звезди"><svg viewBox="0 0 24 24"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg></button>
          <button type="button" class="star" data-value="4" aria-label="4 звезди"><svg viewBox="0 0 24 24"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg></button>
          <button type="button" class="star" data-value="5" aria-label="5 звезди"><svg viewBox="0 0 24 24"><path d="M12 2.5l2.9 5.9 6.5.9-4.7 4.6 1.1 6.4L12 17.9 6.2 20.3l1.1-6.4L2.6 9.3l6.5-.9L12 2.5z"/></svg></button>
        </div>
      </label>

      <button id="add">Добави и оцени</button>
      <p id="ms" class="muted"></p>
    </div>
  </div>

  <script type="module">
    import { supabase, slugBg, isCyrillicName, getFingerprint } from "/assets/app.js";

    const msg = document.getElementById("ms");

    // Star widget
    const stars = Array.from(document.querySelectorAll('#stars .star'));
    let score = 0;
    const paint = n => stars.forEach((s,i)=>s.classList.toggle('filled', i<n));
    stars.forEach(btn => {
      const v = Number(btn.dataset.value);
      btn.addEventListener('mouseenter', ()=>paint(v));
      btn.addEventListener('mouseleave', ()=>paint(score));
      btn.addEventListener('click', ()=>{ score=v; paint(score); });
    });

    document.getElementById("add").onclick = async ()=>{
      msg.className="muted"; msg.textContent="Записваме…";
      const display = document.getElementById("nm").value.trim();
      const g = (document.getElementById("a-m").checked && 'm') || (document.getElementById("a-f").checked && 'f') || (document.getElementById("a-u").checked && 'u') || "";
      if (!display || !g){ msg.className="err"; msg.textContent="Моля въведи име и пол."; return; }
      if (!isCyrillicName(display)){ msg.className="err"; msg.textContent="Само кирилица (2–60 знака)."; return; }
      if (!score){ msg.className="err"; msg.textContent="Моля постави оценка със звездите."; return; }

      const slug = slugBg(display);

      // Insert or fetch name
      let nameId = null, existed = false;
      const ins = await supabase.from("names").insert({ display, normalized_slug: slug, gender:g }).select("id").maybeSingle();
      if (ins.error){
        if ((ins.error.message||"").toLowerCase().includes("duplicate")){
          const { data } = await supabase.from("names").select("id").eq("normalized_slug", slug).maybeSingle();
          nameId = data?.id || null; existed = true;
        } else {
          msg.className="err"; msg.textContent="Грешка: " + ins.error.message; return;
        }
      } else {
        nameId = ins.data?.id || null;
      }

      if (!nameId){ msg.className="err"; msg.textContent="Неуспешно намиране/добавяне на името."; return; }

      // Rate as non-holder
      const up = await supabase.from("ratings").upsert({
        name_id: nameId,
        rater_is_holder: false,
        age_bucket: null,
        score,
        user_fingerprint: getFingerprint()
      }, { onConflict: 'name_id,user_fingerprint' });

      if (up.error){
        msg.className="err"; msg.textContent="Грешка при оценяване: " + up.error.message; return;
      }

      msg.className="ok";
      msg.textContent = existed ? "Името вече съществува — записахме оценката ти. ✅" : "Добавено и оценено! ✅";
      document.getElementById("nm").value="";
      stars.forEach(s=>s.classList.remove('filled')); score=0;
      document.getElementById("a-m").checked=false; document.getElementById("a-f").checked=false; document.getElementById("a-u").checked=false;
    };
  </script>
</body>
</html>
